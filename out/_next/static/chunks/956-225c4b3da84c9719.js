"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[956],{4362:function(e,r,t){t.d(r,{AuthProvider:function(){return l},a:function(){return d}});var a=t(7437),o=t(2265),s=t(3301),i=t(6410);new Date().toISOString(),new Date().toISOString(),()=>({});let n=(0,o.createContext)(void 0),d=()=>{let e=(0,o.useContext)(n);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e},l=e=>{let{children:r}=e,[t,d]=(0,o.useState)(null),[l,c]=(0,o.useState)(!0);(0,o.useEffect)(()=>(console.log("AuthProvider - AUTH_ENABLED:",!0),console.log("AuthProvider - Environment:","production"),(0,s.Aj)(i.I,e=>{console.log("AuthProvider - Auth state changed:",{uid:null==e?void 0:e.uid,email:null==e?void 0:e.email,emailVerified:null==e?void 0:e.emailVerified,isAnonymous:null==e?void 0:e.isAnonymous}),d(e),c(!1)})),[]);let u=async(e,r,t)=>{try{let a=await (0,s.Xb)(i.I,e,r);await (0,s.ck)(a.user,{displayName:t})}catch(e){throw e}},h=async(e,r)=>{try{console.log("AuthProvider - Signing in with email:",e);let t=await (0,s.e5)(i.I,e,r);console.log("AuthProvider - User signed in successfully:",{uid:t.user.uid,email:t.user.email,emailVerified:t.user.emailVerified})}catch(e){throw console.error("Sign in error:",e),e}},g=async()=>{try{let e=new s.hJ;await (0,s.rh)(i.I,e)}catch(e){throw e}},f=async()=>{try{await (0,s.w7)(i.I)}catch(e){throw e}},v=async e=>{try{await (0,s.LS)(i.I,e)}catch(e){throw e}};return(0,a.jsx)(n.Provider,{value:{user:t,loading:l,signUp:u,signIn:h,signInWithGoogle:g,signOut:f,resetPassword:v,isAuthEnabled:!0},children:r})}},6956:function(e,r,t){t.d(r,{B:function(){return c},DataManagerProvider:function(){return l}});var a=t(7437),o=t(2265),s=t(7442),i=t(763),n=t(4362);let d=(0,o.createContext)(void 0),l=e=>{let{children:r}=e,{user:t,loading:l,isAuthEnabled:c}=(0,n.a)(),[u,h]=(0,o.useState)(new s.A),[g,f]=(0,o.useState)(!1),[v]=(0,o.useState)(new i.q);(0,o.useEffect)(()=>{l||(c&&t?(v.setUser(t),h(v),f(!0)):(h(new s.A),f(!1)))},[t,l,c,v]);let w=async()=>{if(!c)throw Error("認証機能が無効になっているため、クラウドモードに切り替えできません");if(!t)throw Error("クラウドモードに切り替えるにはログインが必要です");v.setUser(t),h(v),f(!0)},C=async()=>{if(!c)return console.error("認証機能が無効になっているため、クラウドに移行できません"),!1;if(!t)return console.error("クラウドに移行するにはログインが必要です"),!1;try{let e=new s.A,r=await e.getAllCards();if(0===r.length)return!0;let t=await v.migrateFromLocalStorage(r);if(t.success)return console.log("".concat(r.length," 件のカードをクラウドに移行しました")),!0;return console.error("移行に失敗しました:",t.errors),!1}catch(e){return console.error("移行中にエラーが発生しました:",e),!1}};return(0,a.jsx)(d.Provider,{value:{dataManager:u,isCloudMode:g,switchToCloud:w,switchToLocal:()=>{h(new s.A),f(!1)},migrateToCloud:C},children:r})},c=()=>{let e=(0,o.useContext)(d);if(void 0===e)throw Error("useDataManager must be used within a DataManagerProvider");return e}},6410:function(e,r,t){t.d(r,{I:function(){return n},db:function(){return d}});var a=t(738),o=t(3301),s=t(5978);let i=(0,a.ZF)({apiKey:"AIzaSyBJSobP7SJjT0kLDKx7cIrq2uCeTlKs978",authDomain:"meku-run.firebaseapp.com",projectId:"meku-run",storageBucket:"meku-run.firebasestorage.app",messagingSenderId:"762843174518",appId:"1:762843174518:web:7057c9553148b56719b157"}),n=(0,o.v0)(i),d=(0,s.ad)(i)},763:function(e,r,t){t.d(r,{q:function(){return s}});var a=t(5978),o=t(6410);class s{setUser(e){this.user=e}ensureUser(){if(!this.user)throw Error("User must be set to use FirebaseManager")}getUserId(){return this.ensureUser(),this.user.uid}getCollectionRef(){let e=this.getUserId();return(0,a.hJ)(o.db,"users",e,"wordCards")}convertFirestoreToWordCard(e){var r,t,a,o,s,i;let n=e.data();return{id:e.id,word:n.word,meaning:n.meaning,created_at:(null===(a=n.created_at)||void 0===a?void 0:null===(t=a.toDate)||void 0===t?void 0:null===(r=t.call(a))||void 0===r?void 0:r.toISOString())||n.created_at,updated_at:(null===(i=n.updated_at)||void 0===i?void 0:null===(s=i.toDate)||void 0===s?void 0:null===(o=s.call(i))||void 0===o?void 0:o.toISOString())||n.updated_at,tags:n.tags||[],isStarred:n.isStarred||!1,user_id:this.getUserId()}}async getAllCards(){var e,r,t,o,s,i,n,d,l;this.ensureUser(),console.log("FirebaseManager.getAllCards() - User:",null===(e=this.user)||void 0===e?void 0:e.uid),console.log("FirebaseManager.getAllCards() - User email:",null===(r=this.user)||void 0===r?void 0:r.email),console.log("FirebaseManager.getAllCards() - User email verified:",null===(t=this.user)||void 0===t?void 0:t.emailVerified);try{if(!(null===(o=this.user)||void 0===o?void 0:o.uid))throw Error("User is not authenticated");let e=this.getCollectionRef();console.log("FirebaseManager.getAllCards() - Collection path:","users/".concat(this.user.uid,"/wordCards"));let r=await (0,a.PL)(e);console.log("FirebaseManager.getAllCards() - Snapshot size:",r.size);let t=[];return r.forEach(e=>{t.push(this.convertFirestoreToWordCard(e))}),t.sort((e,r)=>new Date(r.created_at).getTime()-new Date(e.created_at).getTime()),t}catch(e){throw console.error("FirebaseManager.getAllCards() - Full error:",e),console.error("FirebaseManager.getAllCards() - Error code:",e.code),console.error("FirebaseManager.getAllCards() - Error message:",e.message),"permission-denied"===e.code&&console.error("Permission denied. User info:",{uid:null===(s=this.user)||void 0===s?void 0:s.uid,email:null===(i=this.user)||void 0===i?void 0:i.email,emailVerified:null===(n=this.user)||void 0===n?void 0:n.emailVerified,isAnonymous:null===(d=this.user)||void 0===d?void 0:d.isAnonymous,providerData:null===(l=this.user)||void 0===l?void 0:l.providerData}),Error("Failed to fetch cards: ".concat(e))}}async getCard(e){try{let r=(0,a.JU)(this.getCollectionRef(),e),t=await (0,a.QT)(r);if(!t.exists())return null;return this.convertFirestoreToWordCard(t)}catch(e){throw console.error("Error fetching card from Firebase:",e),Error("Failed to fetch card: ".concat(e))}}async createCard(e){try{let r=await (0,a.ET)(this.getCollectionRef(),{...e,created_at:(0,a.Bt)(),updated_at:(0,a.Bt)()}),t=await (0,a.QT)(r);if(!t.exists())throw Error("Failed to create card");return this.convertFirestoreToWordCard(t)}catch(e){throw console.error("Error creating card in Firebase:",e),Error("Failed to create card: ".concat(e))}}async updateCard(e,r){try{let t=(0,a.JU)(this.getCollectionRef(),e),{user_id:o,...s}=r;await (0,a.r7)(t,{...s,updated_at:(0,a.Bt)()});let i=await (0,a.QT)(t);if(!i.exists())throw Error("Card with id ".concat(e," not found"));return this.convertFirestoreToWordCard(i)}catch(e){throw console.error("Error updating card in Firebase:",e),Error("Failed to update card: ".concat(e))}}async deleteCard(e){try{let r=(0,a.JU)(this.getCollectionRef(),e);await (0,a.oe)(r)}catch(e){throw console.error("Error deleting card from Firebase:",e),Error("Failed to delete card: ".concat(e))}}async createCards(e){try{let r=(0,a.qs)(o.db),t=[];e.forEach(e=>{let o=(0,a.JU)(this.getCollectionRef());r.set(o,{...e,created_at:(0,a.Bt)(),updated_at:(0,a.Bt)()}),t.push(o)}),await r.commit();let s=[];for(let e of t){let r=await (0,a.QT)(e);r.exists()&&s.push(this.convertFirestoreToWordCard(r))}return s}catch(e){throw console.error("Error creating cards in Firebase:",e),Error("Failed to create cards: ".concat(e))}}async deleteAllCards(){try{let e=await (0,a.PL)(this.getCollectionRef()),r=(0,a.qs)(o.db);e.forEach(e=>{r.delete(e.ref)}),await r.commit()}catch(e){throw console.error("Error deleting all cards from Firebase:",e),Error("Failed to delete all cards: ".concat(e))}}async syncData(){try{return await this.getAllCards(),{success:!0}}catch(e){return console.error("Error syncing data:",e),{success:!1,errors:[e instanceof Error?e:Error("Unknown sync error")]}}}isOffline(){return!navigator.onLine}subscribeToCards(e){let r=(0,a.IO)(this.getCollectionRef(),(0,a.Xo)("created_at","desc")),t=(0,a.cf)(r,r=>{let t=[];r.forEach(e=>{t.push(this.convertFirestoreToWordCard(e))}),e(t)},e=>{console.error("Error in real-time listener:",e)});return this.unsubscribeListeners.push(t),t}cleanup(){this.unsubscribeListeners.forEach(e=>e()),this.unsubscribeListeners=[]}async migrateFromLocalStorage(e){try{let r=await this.getAllCards(),t=new Set(r.map(e=>e.id)),a=e.filter(e=>!t.has(e.id));if(0===a.length)return{success:!0};let o=a.map(e=>{let{id:r,created_at:t,updated_at:a,user_id:o,...s}=e;return s});return await this.createCards(o),{success:!0}}catch(e){return console.error("Error migrating from localStorage:",e),{success:!1,errors:[e instanceof Error?e:Error("Migration failed")]}}}constructor(e=null){this.user=null,this.unsubscribeListeners=[],this.user=e}}},7442:function(e,r,t){t.d(r,{A:function(){return o}});let a="wordCards";class o{generateId(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}getCurrentTimestamp(){return new Date().toISOString()}getStoredCards(){try{let e=localStorage.getItem(a);return e?JSON.parse(e):[]}catch(e){return console.error("Error reading from localStorage:",e),[]}}saveCards(e){try{localStorage.setItem(a,JSON.stringify(e))}catch(e){throw console.error("Error saving to localStorage:",e),Error("Failed to save data to local storage")}}async getAllCards(){return this.getStoredCards()}async getCard(e){return this.getStoredCards().find(r=>r.id===e)||null}async createCard(e){let r=this.getStoredCards(),t=this.getCurrentTimestamp(),a={...e,id:this.generateId(),created_at:t,updated_at:t};return r.push(a),this.saveCards(r),a}async updateCard(e,r){var t,a;let o=this.getStoredCards(),s=o.findIndex(r=>r.id===e);if(-1===s)throw Error("Card with id ".concat(e," not found"));let i=o[s],n={...i,...r,updated_at:this.getCurrentTimestamp(),id:i.id,word:null!==(t=r.word)&&void 0!==t?t:i.word,meaning:null!==(a=r.meaning)&&void 0!==a?a:i.meaning,created_at:i.created_at};return o[s]=n,this.saveCards(o),n}async deleteCard(e){let r=this.getStoredCards(),t=r.filter(r=>r.id!==e);if(t.length===r.length)throw Error("Card with id ".concat(e," not found"));this.saveCards(t)}async createCards(e){let r=this.getStoredCards(),t=this.getCurrentTimestamp(),a=e.map(e=>({...e,id:this.generateId(),created_at:t,updated_at:t}));return r.push(...a),this.saveCards(r),a}async deleteAllCards(){this.saveCards([])}isOffline(){return!0}}}}]);